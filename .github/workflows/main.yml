name: Localization & Build

################################################################################
# è§¦å‘æ¡ä»¶
################################################################################
# â‘  å¼€å‘è€…å‘ main æ¨ä»£ç ï¼ˆ.resx æˆ–å…¶å®ƒæºç ï¼‰
# â‘¡ Weblate æŠŠç¿»è¯‘ push åˆ° locales åˆ†æ”¯
# â‘¢ æ‰‹åŠ¨ workflow_dispatch
on:
  push:
    branches: [ master, locales ]
  workflow_dispatch:

################################################################################
# job 1: ä» main åˆ†æ”¯æ”¶é›†é»˜è®¤ .resxï¼Œæ¨åˆ° locales åˆ†æ”¯ä¾› Weblate ç¿»è¯‘
################################################################################
jobs:
  sync-resx:
    if: github.ref == 'refs/heads/main'      # åªåœ¨ main æ¨é€æ—¶è·‘
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸  Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # è¦èƒ½æ¨é€æ–°åˆ†æ”¯ï¼Œå¿…é¡»æ‹¿åˆ°å®Œæ•´å†å²

      - name: ğŸ§¹  Sync resx to locales/en
        run: |
          bash .github/scripts/sync_resx.sh   # å‰é¢å†™å¥½çš„è„šæœ¬

      - name: ğŸš€  Push locales branch
        run: |
          git push -f origin HEAD:locales

################################################################################
# job 2: ç¼–è¯‘å‡ºå¤šè¯­è¨€å«æ˜Ÿ dllï¼Œå¹¶ä¸Šä¼ åˆ¶å“
################################################################################
  build:
    needs: [sync-resx]               # åªæœ‰ sync-resx æˆåŠŸæˆ–åˆ†æ”¯æ˜¯ locales æ—¶æ‰ç¼–
    runs-on: windows-latest          # .NET 4.8 â†’ ç”¨ Windows runner

    steps:
      - name: â¬‡ï¸  Checkout (main + locales)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å– main æºç ï¼Œå†æ‹‰ locales åˆ†æ”¯çš„ç¿»è¯‘æ–‡ä»¶
      - name: ğŸ”€  Merge locales into working tree
        run: |
          git fetch origin locales
          git merge --no-edit --strategy-option ours origin/locales || echo "Already merged"

      - name: ğŸ› ï¸  Setup MSBuild (VS BuildTools)
        uses: microsoft/setup-msbuild@v1.3

      - name: ğŸ› ï¸  Restore NuGet (è‹¥æœ‰)
        run: nuget restore TranslateDLL.sln

      - name: âš™ï¸  Build Release + å«æ˜Ÿ DLL
        run: |
          msbuild TranslateDLL.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /verbosity:minimal

      - name: ğŸ“¦  Upload artifacts (exe + satellites)
        uses: actions/upload-artifact@v4
        with:
          name: app_release
          path: |
            TranslateDLL/bin/Release/TranslateDLL.exe
            TranslateDLL/bin/Release/**/TranslateDLL.resources.dll
