name: Localization & Build

on:
  push:
    branches: [ master, locales ]
  workflow_dispatch:

jobs:
  sync-resx:
    # âœ… ä»…åœ¨ master åˆ†æ”¯è§¦å‘
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸  Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹  Sync resx to locales/en
        run: |
          bash .github/scripts/sync_resx.sh

      - name: ğŸš€  Push to locales branch with BOT_TOKEN
        run: |
          git config user.name "CI Bot"
          git config user.email "ci@example.com"
          git remote set-url origin https://x-access-token:${{ secrets.BOT_TOKEN }}@github.com/${{ github.repository }}
          git push -f origin HEAD:locales

  build:
    # âœ… æ— è®ºè°è§¦å‘ï¼Œéƒ½èƒ½ç‹¬ç«‹æ‰§è¡Œï¼›å¦‚æœæ˜¯ masterï¼Œè¿˜ä¼šè‡ªåŠ¨ merge locales
    runs-on: windows-latest
    steps:
      - name: â¬‡ï¸  Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âœ… å¦‚æœå½“å‰åˆ†æ”¯æ˜¯ masterï¼Œåˆ™ merge locales ä»¥è·å¾—æœ€æ–°ç¿»è¯‘
      - name: ğŸ”€  Merge locales if needed
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.BOT_TOKEN }}@github.com/${{ github.repository }}
          if [ "${{ github.ref_name }}" = "master" ]; then
            git fetch origin locales
            git merge --no-edit --strategy-option ours origin/locales || echo "Already merged"
          fi

      - name: ğŸ› ï¸  Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3

      - name: ğŸ› ï¸  Restore NuGet (å¯é€‰)
        run: nuget restore TranslateDLL.sln

      - name: âš™ï¸  Build Release + å«æ˜Ÿ DLL
        run: |
          msbuild TranslateDLL.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /verbosity:minimal

      - name: ğŸ“¦  Upload artifacts (exe + satellites)
        uses: actions/upload-artifact@v4
        with:
          name: app_release
          path: |
            TranslateDLL/bin/Release/TranslateDLL.exe
            TranslateDLL/bin/Release/**/TranslateDLL.resources.dll
